---
apiVersion: v1
kind: Service
metadata:
  name: node-metrics
  namespace: {{ namespace }}
  labels:
    app: node-metrics
spec:
  selector:
    app: node-metrics
  ports:
    - name: http
      port: 9100
      targetPort: 9100
  type: ClusterIP
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-metrics
  namespace: {{ namespace }}
  labels:
    app: node-metrics
spec:
  selector:
    matchLabels:
      app: node-metrics
  template:
    metadata:
      labels:
        app: node-metrics
    spec:
      hostPID: true
      containers:
      - name: node-metrics
        image: python:3.11-slim
        command:
          - sh
          - -c
          - |
            apt-get update -qq && apt-get install -y -qq util-linux > /dev/null 2>&1
            python3 -u -c '
            from http.server import BaseHTTPRequestHandler, HTTPServer
            import json
            import subprocess

            class MetricsHandler(BaseHTTPRequestHandler):
                def do_GET(self):
                    if self.path == '/metrics':
                        try:
                            # Read /proc/meminfo
                            with open('/host/proc/meminfo', 'r') as f:
                                meminfo = {}
                                for line in f:
                                    parts = line.split(':')
                                    if len(parts) == 2:
                                        key = parts[0].strip()
                                        value = parts[1].strip().split()[0]  # Get number only
                                        meminfo[key] = int(value) * 1024  # Convert KB to bytes

                            # Read /proc/stat for CPU
                            with open('/host/proc/stat', 'r') as f:
                                cpu_line = f.readline()
                                cpu_times = [int(x) for x in cpu_line.split()[1:]]
                                total_time = sum(cpu_times)
                                idle_time = cpu_times[3]  # idle is 4th field

                            # Get GPU stats from nvidia-smi (run in host namespace using nsenter)
                            try:
                                result = subprocess.run(
                                    [\"nsenter\", \"-t\", \"1\", \"-m\", \"-u\", \"-n\", \"-i\", \"nvidia-smi\", \"--query-gpu=utilization.gpu,memory.used,memory.total,temperature.gpu,power.draw\", \"--format=csv,noheader,nounits\"],
                                    capture_output=True, text=True, timeout=2
                                )
                                if result.returncode == 0:
                                    gpu_data = result.stdout.strip().split(',')
                                    gpu_util = float(gpu_data[0].strip())
                                    gpu_mem_used = float(gpu_data[1].strip())
                                    gpu_mem_total = float(gpu_data[2].strip())
                                    gpu_temp = float(gpu_data[3].strip())
                                    gpu_power = float(gpu_data[4].strip())
                                else:
                                    gpu_util = 0
                                    gpu_mem_used = 0
                                    gpu_mem_total = 0
                                    gpu_temp = 0
                                    gpu_power = 0
                            except Exception:
                                gpu_util = 0
                                gpu_mem_used = 0
                                gpu_mem_total = 0
                                gpu_temp = 0
                                gpu_power = 0

                            metrics = {
                                'memory_total_bytes': meminfo.get('MemTotal', 0),
                                'memory_free_bytes': meminfo.get('MemFree', 0),
                                'memory_available_bytes': meminfo.get('MemAvailable', 0),
                                'memory_used_bytes': meminfo.get('MemTotal', 0) - meminfo.get('MemAvailable', 0),
                                'memory_buffers_bytes': meminfo.get('Buffers', 0),
                                'memory_cached_bytes': meminfo.get('Cached', 0),
                                'cpu_total_time': total_time,
                                'cpu_idle_time': idle_time,
                                'gpu_utilization': gpu_util,
                                'gpu_memory_used_mb': gpu_mem_used,
                                'gpu_memory_total_mb': gpu_mem_total,
                                'gpu_temp': gpu_temp,
                                'gpu_power': gpu_power
                            }

                            self.send_response(200)
                            self.send_header('Content-type', 'application/json')
                            self.end_headers()
                            self.wfile.write(json.dumps(metrics).encode())
                        except Exception as e:
                            self.send_response(500)
                            self.send_header('Content-type', 'application/json')
                            self.end_headers()
                            self.wfile.write(json.dumps({'error': str(e)}).encode())
                    else:
                        self.send_response(404)
                        self.end_headers()

                def log_message(self, format, *args):
                    pass  # Suppress logs

            server = HTTPServer((\"0.0.0.0\", 9100), MetricsHandler)
            print(\"Node metrics server started on port 9100\")
            server.serve_forever()
            '
        ports:
        - containerPort: 9100
          name: http
        volumeMounts:
        - name: proc
          mountPath: /host/proc
          readOnly: true
        resources:
          requests:
            memory: 32Mi
            cpu: 10m
          limits:
            memory: 64Mi
            cpu: 50m
        securityContext:
          privileged: false
          readOnlyRootFilesystem: false
      volumes:
      - name: proc
        hostPath:
          path: /proc
          type: Directory
      tolerations:
      - effect: NoSchedule
        operator: Exists
