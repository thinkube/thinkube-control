# IMPORTANT: This file was originally based on:
# /home/thinkube/thinkube/ansible/roles/container_deployment/repo/tasks/main.yaml
# but has been modified for thinkube-control's specific template deployment needs.
# These files are NO LONGER kept in sync.

- name: Debug Repository Information
  debug:
    msg:
      - "Template URL: {{ template_url }}"
      - "Target Repo Name: {{ gitea_repo_name }}"
      - "Local Repo Path: {{ code_source_path }}/{{ gitea_repo_name }}"

- name: Check if Copier is installed in virtualenv
  ansible.builtin.command:
    cmd: ~/.venv/bin/pip show copier
  register: copier_check
  failed_when: false
  changed_when: false

- name: Install Copier in virtualenv
  ansible.builtin.pip:
    name: copier
    state: present
    virtualenv: ~/.venv
  when: copier_check.rc != 0

- name: Ensure parent directory exists
  file:
    path: "{{ code_source_path }}"
    state: directory
    mode: '0755'

- name: Configure git to avoid race conditions (force synchronous operations)
  ansible.builtin.shell: |
    # Force single-threaded operations
    git config --global pack.threads 1
    git config --global index-pack.threads 1
    git config --global checkout.workers 1
    git config --global core.preloadIndex false

    # Force synchronous filesystem operations
    git config --global core.fsyncObjectFiles true
    git config --global core.fsync all
  args:
    executable: /bin/bash
  changed_when: false

- name: Clone template to /tmp with shallow clone
  ansible.builtin.shell: |
    # Extract template name from URL
    TEMPLATE_NAME=$(basename {{ template_url }} .git)
    TEMP_PATH="/tmp/thinkube-templates-${USER}/${TEMPLATE_NAME}"

    echo "=== Cloning template to temporary location ==="
    echo "Template: {{ template_url }}"
    echo "Temp path: $TEMP_PATH"

    # Clean up any existing temp directory for this template
    rm -rf "$TEMP_PATH"
    mkdir -p "$(dirname $TEMP_PATH)"

    # Configure SSH for private repositories if key path is provided
    {% if ssh_private_key_path is defined and ssh_private_key_path %}
    export GIT_SSH_COMMAND="ssh -i {{ ssh_private_key_path }} -o StrictHostKeyChecking=no"
    {% endif %}

    # Shallow clone (last commit only) to avoid git race conditions
    git clone --depth=1 {{ template_url }} "$TEMP_PATH"

    echo "Template path: $TEMP_PATH"
  args:
    executable: /bin/bash
  register: template_clone_result

- name: Use Copier with locally cloned template
  ansible.builtin.shell: |
    cd {{ code_source_path }}

    # Debug environment
    echo "=== DEBUG: Environment Info ==="
    echo "Current user: $(whoami)"
    echo "Current directory: $(pwd)"
    echo "HOME: $HOME"
    echo "PATH: $PATH"
    echo "Directory permissions: $(ls -ld {{ code_source_path }})"
    echo "Can write to directory: $(touch {{ code_source_path }}/test-write && echo 'YES' || echo 'NO')"
    rm -f {{ code_source_path }}/test-write
    echo "Copier location: $(which copier || echo 'copier not in PATH')"
    echo "Copier in venv: $(ls -la ~/.venv/bin/copier 2>&1)"
    echo "Python in venv: $(~/.venv/bin/python --version 2>&1)"
    echo "=== END DEBUG ==="

    # Remove existing directory if it exists
    if [ -d "{{ gitea_repo_name }}" ]; then
      rm -rf "{{ gitea_repo_name }}"
    fi

    # Extract template path from clone output
    TEMPLATE_NAME=$(basename {{ template_url }} .git)
    TEMP_PATH="/tmp/thinkube-templates-${USER}/${TEMPLATE_NAME}"

    # Build copier command with dynamic parameters
    # Note: --vcs-ref=HEAD is removed because we're using a local path, not a git URL
    COPIER_CMD="~/.venv/bin/copier copy --trust --defaults"
    
    # Add required parameters
    COPIER_CMD="$COPIER_CMD --data 'project_name={{ app_name }}'"
    COPIER_CMD="$COPIER_CMD --data 'project_description={{ project_description | default(app_name + ' application') }}'"
    COPIER_CMD="$COPIER_CMD --data 'domain_name={{ domain_name }}'"
    COPIER_CMD="$COPIER_CMD --data 'container_registry={{ container_registry }}'"
    COPIER_CMD="$COPIER_CMD --data 'author_name={{ author_name }}'"
    COPIER_CMD="$COPIER_CMD --data 'author_email={{ author_email }}'"
    
    # Add template-specific parameters (excluding system vars)
    {% set system_vars = ['ansible_user', 'ansible_ssh_private_key_file', 'ansible_ssh_pass', 
                          'ansible_become_pass', 'app_name', 'template_url', 'deployment_namespace',
                          'domain_name', 'admin_username', 'admin_password', 'github_token',
                          'author_name', 'author_email', 'project_name', 'project_description',
                          'container_registry', 'overwrite_existing'] %}
    {% for key, value in vars.items() %}
    {% if key not in system_vars and not key.startswith('ansible_') and not key.startswith('gitea_') 
          and not key.startswith('keycloak_') and not key.startswith('argocd_') 
          and not key.startswith('harbor_') and not key.startswith('shared_')
          and not key.startswith('local_') and not key.startswith('code_')
          and not key.startswith('use_') and not key.startswith('enable_')
          and key not in ['kubeconfig', 'groups', 'group_names', 'inventory_hostname', 'hostvars', 'vars', 'omit',
                          'wildcard_cert', 'admin_credentials_secret', 'harbor_robot_secret', 
                          'admin_password_from_secret', 'copier_check', 'playbook_dir', 'role_names',
                          'role_name', 'role_path', 'role_uuid', 'play_hosts', 'environment',
                          'gather_subset', 'module_setup', 'k8s_namespace', 'app_host']
          and value is defined and value != '' and value is string %}
    COPIER_CMD="$COPIER_CMD --data {{ key }}={{ value | quote }}"
    {% endif %}
    {% endfor %}
    
    # Execute copier with all parameters using local template path
    echo "=== DEBUG: Copier Command ==="
    echo "Full command: $COPIER_CMD '$TEMP_PATH' '{{ gitea_repo_name }}'"
    echo "Template path: $TEMP_PATH"
    echo "=== Running Copier ==="

    # Run with timeout - should be faster since no git operations
    timeout 120 bash -c "eval \"$COPIER_CMD '$TEMP_PATH' '{{ gitea_repo_name }}'\"" 2>&1
    COPIER_EXIT=$?
    
    echo "=== Copier Exit Code: $COPIER_EXIT ==="
    if [ $COPIER_EXIT -eq 124 ]; then
      echo "ERROR: Copier command timed out after 120 seconds"
      # Clean up temp directory on failure
      rm -rf "$TEMP_PATH"
      exit 1
    elif [ $COPIER_EXIT -ne 0 ]; then
      echo "ERROR: Copier command failed with exit code $COPIER_EXIT"
      # Clean up temp directory on failure
      rm -rf "$TEMP_PATH"
      exit 1
    fi

    # Clean up temp directory on success
    echo "=== Cleaning up temporary template directory ==="
    rm -rf "$TEMP_PATH"
    echo "Cleanup complete"
  args:
    executable: /bin/bash
  async: 180  # Give ansible 3 minutes before timing out
  poll: 5     # Check every 5 seconds

- name: Read manifest.yaml if it exists
  ansible.builtin.slurp:
    src: "{{ code_source_path }}/{{ gitea_repo_name }}/manifest.yaml"
  register: manifest_file
  ignore_errors: true

- name: Parse manifest content
  ansible.builtin.set_fact:
    manifest_content: "{{ manifest_file.content | b64decode | from_yaml }}"
  when: manifest_file is not failed

- name: Ensure application namespace exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ deployment_namespace }}"
  when: manifest_file is not failed

- name: Process application secrets
  ansible.builtin.include_tasks: "/home/thinkube-control/tasks/inject_secrets.yaml"
  vars:
    api_token: "{{ cicd_api_token }}"
    k8s_namespace: "{{ deployment_namespace }}"
    app_name: "{{ project_name }}"
  when: manifest_file is not failed

- name: Generate k8s manifests from thinkube.yaml
  ansible.builtin.include_tasks: "/home/thinkube-control/tasks/generate_k8s_manifests.yaml"
  vars:
    local_repo_path: "{{ code_source_path }}/{{ gitea_repo_name }}"

- name: Initialize git repository in the copied directory
  ansible.builtin.shell: |
    cd {{ code_source_path }}/{{ gitea_repo_name }}

    # Check if git is already initialized
    if [ ! -d .git ]; then
      git init -b main
    fi

    # Configure git user for this repository
    git config user.name "{{ git_user_name | default('Thinkube Automation') }}"
    git config user.email "{{ git_user_email | default('automation@' + domain_name) }}"

    # Only commit if there are changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
      git add -A
      git commit -m "Initial deployment for {{ domain_name }}"
    elif [ -z "$(git log 2>/dev/null)" ]; then
      # No commits yet, create initial commit
      git add -A
      git commit -m "Initial deployment for {{ domain_name }}"
    else
      echo "Repository already initialized with commits, skipping commit"
    fi
  args:
    executable: /bin/bash