# IMPORTANT: This file was originally based on:
# /home/thinkube/thinkube/ansible/roles/container_deployment/repo/tasks/main.yaml
# but has been modified for thinkube-control's specific template deployment needs.
# These files are NO LONGER kept in sync.

- name: Debug Repository Information
  debug:
    msg:
      - "Template URL: {{ template_url }}"
      - "Target Repo Name: {{ gitea_repo_name }}"
      - "Local Repo Path: {{ code_source_path }}/{{ gitea_repo_name }}"

- name: Check if Copier is installed in virtualenv
  ansible.builtin.command:
    cmd: ~/.venv/bin/pip show copier
  register: copier_check
  failed_when: false
  changed_when: false

- name: Install Copier in virtualenv
  ansible.builtin.pip:
    name: copier
    state: present
    virtualenv: ~/.venv
  when: copier_check.rc != 0

- name: Ensure parent directory exists
  file:
    path: "{{ code_source_path }}"
    state: directory
    mode: '0755'

- name: Configure git to avoid race conditions (force synchronous operations)
  ansible.builtin.shell: |
    # Force single-threaded operations
    git config --global pack.threads 1
    git config --global index-pack.threads 1
    git config --global checkout.workers 1
    git config --global core.preloadIndex false

    # Force synchronous filesystem operations
    git config --global core.fsyncObjectFiles true
    git config --global core.fsync all
  args:
    executable: /bin/bash
  changed_when: false

- name: Clone template to /tmp with shallow clone
  ansible.builtin.shell: |
    # Extract template name from URL
    TEMPLATE_NAME=$(basename {{ template_url }} .git)
    TEMP_PATH="/tmp/thinkube-templates-${USER}/${TEMPLATE_NAME}"

    echo "=== Cloning template to temporary location ==="
    echo "Template: {{ template_url }}"
    echo "Temp path: $TEMP_PATH"

    # Clean up any existing temp directory for this template
    rm -rf "$TEMP_PATH"
    mkdir -p "$(dirname $TEMP_PATH)"

    # Configure SSH for private repositories if key path is provided
    {% if ssh_private_key_path is defined and ssh_private_key_path %}
    export GIT_SSH_COMMAND="ssh -i {{ ssh_private_key_path }} -o StrictHostKeyChecking=no"
    {% endif %}

    # Shallow clone (last commit only) to avoid git race conditions
    git clone --depth=1 {{ template_url }} "$TEMP_PATH"

    echo "Template path: $TEMP_PATH"
  args:
    executable: /bin/bash
  register: template_clone_result

- name: Create Copier execution script from template
  ansible.builtin.template:
    src: run_copier.sh.j2
    dest: /tmp/run_copier_{{ app_name }}.sh
    mode: '0755'

- name: Execute Copier script
  ansible.builtin.command:
    cmd: /tmp/run_copier_{{ app_name }}.sh
  async: 180  # Give ansible 3 minutes before timing out
  poll: 5     # Check every 5 seconds
  register: copier_execution

- name: Clean up Copier script
  ansible.builtin.file:
    path: /tmp/run_copier_{{ app_name }}.sh
    state: absent

- name: Read manifest.yaml if it exists
  ansible.builtin.slurp:
    src: "{{ code_source_path }}/{{ gitea_repo_name }}/manifest.yaml"
  register: manifest_file
  ignore_errors: true

- name: Parse manifest content
  ansible.builtin.set_fact:
    manifest_content: "{{ manifest_file.content | b64decode | from_yaml }}"
  when: manifest_file is not failed

- name: Ensure application namespace exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ deployment_namespace }}"
  when: manifest_file is not failed

- name: Process application secrets
  ansible.builtin.include_tasks: "/home/thinkube-control/tasks/inject_secrets.yaml"
  vars:
    api_token: "{{ cicd_api_token }}"
    k8s_namespace: "{{ deployment_namespace }}"
    app_name: "{{ project_name }}"
  when: manifest_file is not failed

- name: Generate k8s manifests from thinkube.yaml
  ansible.builtin.include_tasks: "/home/thinkube-control/tasks/generate_k8s_manifests.yaml"
  vars:
    local_repo_path: "{{ code_source_path }}/{{ gitea_repo_name }}"

- name: Initialize git repository in the copied directory
  ansible.builtin.shell: |
    cd {{ code_source_path }}/{{ gitea_repo_name }}

    # Check if git is already initialized
    if [ ! -d .git ]; then
      git init -b main
    fi

    # Configure git user for this repository
    git config user.name "{{ git_user_name | default('Thinkube Automation') }}"
    git config user.email "{{ git_user_email | default('automation@' + domain_name) }}"

    # Only commit if there are changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
      git add -A
      git commit -m "Initial deployment for {{ domain_name }}"
    elif [ -z "$(git log 2>/dev/null)" ]; then
      # No commits yet, create initial commit
      git add -A
      git commit -m "Initial deployment for {{ domain_name }}"
    else
      echo "Repository already initialized with commits, skipping commit"
    fi
  args:
    executable: /bin/bash