#!/bin/bash
set -e

cd {{ code_source_path }}

# Debug environment
echo "=== DEBUG: Environment Info ==="
echo "Current user: $(whoami)"
echo "Current directory: $(pwd)"
echo "HOME: $HOME"
echo "PATH: $PATH"
echo "Directory permissions: $(ls -ld {{ code_source_path }})"
echo "Can write to directory: $(touch {{ code_source_path }}/test-write && echo 'YES' || echo 'NO')"
rm -f {{ code_source_path }}/test-write
echo "Copier location: $(which copier || echo 'copier not in PATH')"
echo "Copier in venv: $(ls -la ~/.venv/bin/copier 2>&1)"
echo "Python in venv: $(~/.venv/bin/python --version 2>&1)"
echo "=== END DEBUG ==="

# Remove existing directory if it exists
if [ -d "{{ gitea_repo_name }}" ]; then
  rm -rf "{{ gitea_repo_name }}"
fi

# Extract template name and set up temp path with unique identifier
TEMPLATE_NAME=$(basename {{ template_url }} .git)
UNIQUE_ID="$(date +%s)-$$"  # timestamp + process ID for uniqueness
TEMP_PATH="/tmp/thinkube-templates-${USER}/${TEMPLATE_NAME}-${UNIQUE_ID}"

# Clone template to temporary location
echo "=== Cloning template to temporary location ==="
echo "Template: {{ template_url }}"
echo "Temp path: $TEMP_PATH"

# Create parent directory (no need to remove, path is unique)
mkdir -p "$(dirname $TEMP_PATH)"

# Configure single-threaded git operations to reduce race conditions
git config --global pack.threads 1
git config --global index-pack.threads 1
git config --global checkout.workers 1
git config --global core.preloadIndex false

{% if ssh_private_key_path is defined and ssh_private_key_path %}
# Configure SSH for private repositories
export GIT_SSH_COMMAND="ssh -i {{ ssh_private_key_path }} -o StrictHostKeyChecking=no"
{% endif %}

# Shallow clone (last commit only)
git clone --depth=1 {{ template_url }} "$TEMP_PATH"

# Verify clone succeeded
if [ ! -d "$TEMP_PATH" ]; then
  echo "ERROR: Git clone failed - directory does not exist: $TEMP_PATH"
  exit 1
fi

echo "Template cloned successfully to: $TEMP_PATH"
echo ""

# Build copier command with dynamic parameters
# Note: --vcs-ref=HEAD is removed because we're using a local path, not a git URL
COPIER_CMD="~/.venv/bin/copier copy --trust --defaults"

# Add required parameters
COPIER_CMD="$COPIER_CMD --data 'project_name={{ app_name }}'"
COPIER_CMD="$COPIER_CMD --data 'project_description={{ project_description | default(app_name + ' application') }}'"
COPIER_CMD="$COPIER_CMD --data 'domain_name={{ domain_name }}'"
COPIER_CMD="$COPIER_CMD --data 'container_registry={{ container_registry }}'"
COPIER_CMD="$COPIER_CMD --data 'author_name={{ author_name }}'"
COPIER_CMD="$COPIER_CMD --data 'author_email={{ author_email }}'"

# Add template-specific parameters (excluding system vars)
{% set system_vars = ['ansible_user', 'ansible_ssh_private_key_file', 'ansible_ssh_pass',
                      'ansible_become_pass', 'app_name', 'template_url', 'deployment_namespace',
                      'domain_name', 'admin_username', 'admin_password', 'github_token',
                      'author_name', 'author_email', 'project_name', 'project_description',
                      'container_registry', 'overwrite_existing'] %}
{% for key, value in vars.items() %}
{% if key not in system_vars and not key.startswith('ansible_') and not key.startswith('gitea_')
      and not key.startswith('keycloak_') and not key.startswith('argocd_')
      and not key.startswith('harbor_') and not key.startswith('shared_')
      and not key.startswith('local_') and not key.startswith('code_')
      and not key.startswith('use_') and not key.startswith('enable_')
      and key not in ['kubeconfig', 'groups', 'group_names', 'inventory_hostname', 'hostvars', 'vars', 'omit',
                      'wildcard_cert', 'admin_credentials_secret', 'harbor_robot_secret',
                      'admin_password_from_secret', 'copier_check', 'playbook_dir', 'role_names',
                      'role_name', 'role_path', 'role_uuid', 'play_hosts', 'environment',
                      'gather_subset', 'module_setup', 'k8s_namespace', 'app_host']
      and value is defined and value != '' and value is string %}
COPIER_CMD="$COPIER_CMD --data {{ key }}={{ value | quote }}"
{% endif %}
{% endfor %}

# Execute copier with all parameters using local template path
echo "=== DEBUG: Copier Command ==="
echo "Full command: $COPIER_CMD '$TEMP_PATH' '{{ gitea_repo_name }}'"
echo "Template path: $TEMP_PATH"
echo "=== Running Copier ==="

# Run with timeout - should be faster since no git operations
timeout 120 bash -c "$COPIER_CMD \"$TEMP_PATH\" \"{{ gitea_repo_name }}\"" 2>&1
COPIER_EXIT=$?

echo "=== Copier Exit Code: $COPIER_EXIT ==="
if [ $COPIER_EXIT -eq 124 ]; then
  echo "ERROR: Copier command timed out after 120 seconds"
  # Clean up temp directory on failure
  rm -rf "$TEMP_PATH"
  exit 1
elif [ $COPIER_EXIT -ne 0 ]; then
  echo "ERROR: Copier command failed with exit code $COPIER_EXIT"
  # Clean up temp directory on failure
  rm -rf "$TEMP_PATH"
  exit 1
fi

# Clean up temp directory on success
echo "=== Cleaning up temporary template directory ==="
rm -rf "$TEMP_PATH"
echo "Cleanup complete"
