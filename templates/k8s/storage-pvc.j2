# Generated PersistentVolumeClaims for containers with volume mounts or GPU resources
{% for container in thinkube_spec.spec.containers %}
{% if container.volume is defined %}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ project_name }}-{{ container.name }}-storage
  namespace: {{ k8s_namespace }}
  labels:
    app.kubernetes.io/name: {{ project_name }}
    app.kubernetes.io/component: {{ container.name }}
    app.kubernetes.io/managed-by: argocd
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: k8s-hostpath
{% elif container.gpu is defined and container.gpu.count is defined %}
# Auto-generated static PV/PVC for GPU containers (JuiceFS MLflow root access)
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ project_name }}-{{ container.name }}-mlflow-root
spec:
  capacity:
    storage: 1Ti
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: csi.juicefs.com
    fsType: juicefs
    volumeHandle: mlflow
    nodePublishSecretRef:
      name: juicefs-mlflow-secret
      namespace: juicefs
    volumeAttributes:
      juicefs/mount-cpu-limit: ""
      juicefs/mount-cpu-request: ""
      juicefs/mount-memory-limit: ""
      juicefs/mount-memory-request: ""
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ project_name }}-{{ container.name }}-mlflow-models
  namespace: {{ k8s_namespace }}
  labels:
    app.kubernetes.io/name: {{ project_name }}
    app.kubernetes.io/component: {{ container.name }}
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/purpose: mlflow-model-storage
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Ti
  volumeName: {{ project_name }}-{{ container.name }}-mlflow-root
  storageClassName: ""
{% endif %}
{% endfor %}